{% extends "base.html" %}
{% block title %}Campanhas | WHAGO{% endblock %}
{% block content %}
<section class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
  <div>
    <h2 class="page-title">Campanhas</h2>
    <p class="page-subtitle">
      Crie, planeje e acompanhe seus disparos em todas as fases. Gerencie rascunhos, agendamentos e campanhas em andamento com feedback em tempo real.
    </p>
  </div>
  <div class="flex items-center gap-3">
    <button data-test="campaign-wizard-open" class="btn-primary">Nova campanha</button>
    <button id="campaigns-refresh" class="btn-secondary">Atualizar lista</button>
  </div>
</section>

<p id="campaign-feedback" class="mt-4 text-sm text-slate-500" aria-live="polite" role="status"></p>

<section class="mt-4 card">
  <div class="overflow-x-auto">
    <table class="table-auto w-full text-sm" id="campaign-table">
      <thead>
        <tr class="text-left text-slate-500">
          <th class="py-2">Campanha</th>
          <th class="py-2">Status</th>
          <th class="py-2">Progresso</th>
          <th class="py-2">Chips</th>
          <th class="py-2">Criada</th>
          <th class="py-2 text-right">A√ß√µes</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200"></tbody>
    </table>
  </div>
</section>

<section class="mt-6 grid gap-6 lg:grid-cols-2" id="campaign-sidepanels">
  <article class="card space-y-3" id="campaign-insights">
    <div class="card__header">
      <h3 class="card__title">Resumo r√°pido</h3>
      <p class="card__subtitle">KPIs das √∫ltimas campanhas enviadas e rascunhos pendentes.</p>
    </div>
    <dl class="grid gap-4 text-sm sm:grid-cols-2" id="campaign-insights-body"></dl>
    <p class="text-xs text-slate-400" id="campaign-insights-empty">Nenhuma campanha encontrada. Crie sua primeira campanha para acompanhar os KPIs.</p>
  </article>
  <article class="card space-y-3" id="campaign-latest-messages">
    <div class="card__header">
      <h3 class="card__title">√öltimas mensagens enviadas</h3>
      <p class="card__subtitle">Acompanhe distribui√ß√£o entre chips, status de entrega e eventuais falhas.</p>
    </div>
    <div class="overflow-x-auto">
      <table class="table-auto w-full text-xs" id="campaign-messages-table">
        <thead>
          <tr class="text-left text-slate-500">
            <th class="py-2">Contato</th>
            <th class="py-2">Chip</th>
            <th class="py-2">Status</th>
            <th class="py-2">Enviada</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200"></tbody>
      </table>
      <p class="text-xs text-slate-400" id="campaign-messages-empty">Nenhuma mensagem registrada ainda.</p>
    </div>
  </article>
</section>

<div id="campaign-wizard" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="campaign-wizard-title">
  <div class="modal__content wizard">
    <div class="modal__header">
      <div>
        <h3 id="campaign-wizard-title" class="modal__title">Assistente de campanha</h3>
        <p class="text-xs text-slate-500" id="campaign-wizard-subtitle">Preencha as etapas abaixo para concluir sua campanha.</p>
      </div>
      <button type="button" id="campaign-wizard-close" class="modal__close" aria-label="Fechar">‚úï</button>
    </div>

    <ol id="campaign-steps" class="wizard__steps">
      <li data-step="1" class="wizard__step wizard__step--active">1. Informa√ß√µes</li>
      <li data-step="2" class="wizard__step">2. Sele√ß√£o de chips</li>
      <li data-step="3" class="wizard__step">3. Contatos</li>
      <li data-step="4" class="wizard__step">4. Revis√£o</li>
    </ol>

    <p id="campaign-wizard-feedback" class="mt-4 mb-4 text-sm text-slate-500" aria-live="polite" role="status"></p>

    <section id="campaign-step-1" class="wizard__panel">
      <form id="campaign-basic-form" class="space-y-4">
        <div class="space-y-2">
          <label class="card__label" for="campaign-name">Nome da campanha</label>
          <input id="campaign-name" class="input" placeholder="Campanha de oferta" required minlength="3" />
        </div>
        <div class="space-y-2">
          <label class="card__label" for="campaign-description">Descri√ß√£o</label>
          <textarea id="campaign-description" class="input" rows="2" placeholder="Objetivo, p√∫blico, oferta..."></textarea>
        </div>

        <div class="space-y-2">
            <label class="card__label">Fluxo de Mensagens (Steps)</label>
            <div id="campaign-steps-container" class="space-y-3 min-h-[100px] max-h-[350px] overflow-y-auto border border-slate-200 rounded-md p-3 bg-slate-50 custom-scrollbar">
                <p class="text-center text-sm text-gray-400 py-4" id="empty-steps-msg">Adicione etapas √† sua campanha.</p>
            </div>
            <div class="flex gap-2">
                <button type="button" class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" id="btn-add-text">
                    üìù Texto
                </button>
                <button type="button" class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" id="btn-add-media">
                    üñºÔ∏è M√≠dia
                </button>
                <button type="button" class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" id="btn-add-delay">
                    ‚è±Ô∏è Delay
                </button>
            </div>
            <!-- Inputs ocultos para manter compatibilidade com valida√ß√£o antiga se necess√°rio -->
            <textarea id="campaign-template" class="hidden"></textarea> 
        </div>

        <div id="campaign-variables-box" class="hidden space-y-2 rounded-xl border border-dashed border-slate-300 p-3">
          <h4 class="text-sm font-medium text-slate-700">Vari√°veis detectadas</h4>
          <div id="campaign-variables" class="flex flex-wrap gap-2 text-xs"></div>
          <p class="text-xs text-slate-500">Clique em uma vari√°vel para inserir no texto.</p>
        </div>

        <label class="inline-flex items-center gap-2 text-sm text-slate-600">
          <input type="checkbox" id="campaign-schedule-toggle" class="rounded border-slate-300" />
          Agendar envio futuro
        </label>
        <div id="campaign-schedule-fields" class="grid gap-3 md:grid-cols-2 hidden">
          <div class="space-y-2">
            <label class="card__label" for="campaign-schedule-datetime">Data e hora</label>
            <input type="datetime-local" id="campaign-schedule-datetime" class="input" />
          </div>
          <p class="text-xs text-slate-500">
            Dispon√≠vel conforme recursos do plano. Ajuste a data com anteced√™ncia m√≠nima de 10 minutos.
          </p>
        </div>
        <div class="wizard__actions">
          <button type="button" class="btn-secondary" id="campaign-basic-cancel">Cancelar</button>
          <button type="submit" class="btn-primary" data-test="campaign-basic-next">Continuar</button>
        </div>
      </form>
    </section>

    <section id="campaign-step-2" class="wizard__panel hidden">
      <form id="campaign-chips-form" class="space-y-4">
        <p class="text-sm text-slate-600">Selecione os chips que participar√£o desta campanha. A rota√ß√£o autom√°tica distribuir√° as mensagens para reduzir riscos.</p>
        <div id="campaign-chips-list" class="grid gap-3 md:grid-cols-2"></div>
        <div class="space-y-2">
          <label class="card__label" for="campaign-interval">Intervalo m√≠nimo entre mensagens (segundos)</label>
          <input id="campaign-interval" type="number" class="input" min="1" value="10" />
          <label class="inline-flex items-center gap-2 text-sm text-slate-600">
            <input type="checkbox" id="campaign-randomize" class="rounded border-slate-300" />
            Aleatorizar intervalo (¬± 30%)
          </label>
        </div>
        <div class="wizard__actions">
          <button type="button" class="btn-secondary" data-step-back="1">Voltar</button>
          <button type="submit" class="btn-primary" data-test="campaign-chips-next">Continuar</button>
        </div>
      </form>
    </section>

    <section id="campaign-step-3" class="wizard__panel hidden">
      <form id="campaign-contacts-form" class="space-y-4" enctype="multipart/form-data">
        <p class="text-sm text-slate-600">
          Importe uma planilha CSV com pelo menos a coluna <code>numero</code> (E.164). Outras colunas ser√£o tratadas como vari√°veis para personaliza√ß√£o.
        </p>
        <div class="space-y-2">
          <label class="card__label" for="campaign-contacts-file">Arquivo CSV <span class="text-xs text-slate-500">(opcional se j√° importou)</span></label>
          <input id="campaign-contacts-file" type="file" accept=".csv" class="input" />
        </div>
        <div id="campaign-contacts-summary" class="text-sm text-slate-600 hidden"></div>
        <div id="campaign-variables-summary" class="hidden rounded-xl border border-dashed border-slate-300 p-3 text-xs text-slate-600"></div>
        <div class="wizard__actions">
          <button type="button" class="btn-secondary" data-step-back="2">Voltar</button>
          <button type="submit" class="btn-primary" data-test="campaign-contacts-next">Continuar</button>
        </div>
      </form>
    </section>

    <section id="campaign-step-4" class="wizard__panel hidden">
      <div class="space-y-4" id="campaign-review"></div>
      <div class="wizard__actions">
        <button type="button" class="btn-secondary" data-step-back="3">Voltar</button>
        <div class="flex gap-2">
          <button type="button" class="btn-secondary" id="campaign-save-button" data-test="campaign-save">üíæ Salvar</button>
          <button type="button" class="btn-primary" id="campaign-start-button" data-test="campaign-start">üöÄ Iniciar envio</button>
        </div>
      </div>
    </section>
  </div>
</div>
<div id="campaign-wizard-backdrop" class="modal__backdrop hidden" aria-hidden="true"></div>

<!-- Modal Seletor de M√≠dia -->
<div id="media-selector-modal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold leading-6 text-gray-900">Selecionar M√≠dia da Galeria</h3>
                        <button type="button" id="media-selector-close" class="text-gray-400 hover:text-gray-500">
                            <span class="sr-only">Fechar</span>
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div id="media-selector-grid" class="grid grid-cols-3 gap-4 max-h-[400px] overflow-y-auto p-2">
                        <!-- Itens carregados via JS -->
                        <div class="col-span-3 text-center py-8 text-gray-500">Carregando m√≠dia...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    // Estado global dos Steps
    window.campaignSteps = [];

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', () => {
        // Listeners dos bot√µes de adicionar step
        document.getElementById('btn-add-text')?.addEventListener('click', () => addStep('text'));
        document.getElementById('btn-add-media')?.addEventListener('click', () => openMediaSelector());
        document.getElementById('btn-add-delay')?.addEventListener('click', () => addStep('delay'));
        
        // Listener do modal de m√≠dia
        document.getElementById('media-selector-close')?.addEventListener('click', closeMediaSelector);
        
        // Renderizar inicial (vazio)
        renderCampaignSteps();
    });

    function addStep(type, data = {}) {
        const step = { type, ...data };
        if (type === 'text') {
            step.content = '';
        } else if (type === 'delay') {
            step.time = 5;
        }
        window.campaignSteps.push(step);
        renderCampaignSteps();
    }

    function removeStep(index) {
        window.campaignSteps.splice(index, 1);
        renderCampaignSteps();
    }

    function moveStep(index, direction) {
        if (direction === -1 && index > 0) {
            [window.campaignSteps[index], window.campaignSteps[index - 1]] = [window.campaignSteps[index - 1], window.campaignSteps[index]];
        } else if (direction === 1 && index < window.campaignSteps.length - 1) {
            [window.campaignSteps[index], window.campaignSteps[index + 1]] = [window.campaignSteps[index + 1], window.campaignSteps[index]];
        }
        renderCampaignSteps();
    }

    function updateStep(index, field, value) {
        window.campaignSteps[index][field] = value;
        updateHiddenTemplate();
    }

    function updateHiddenTemplate() {
        const texts = window.campaignSteps
            .filter(s => s.type === 'text')
            .map(s => s.content)
            .join('\n---\n');
        
        const hiddenInput = document.getElementById('campaign-template');
        if (hiddenInput) {
            hiddenInput.value = texts || (window.campaignSteps.length > 0 ? '[Campanha Multim√≠dia]' : '');
        }
    }

    window.renderCampaignSteps = function() {
        const container = document.getElementById('campaign-steps-container');
        if (!container) return;
        
        if (window.campaignSteps.length === 0) {
            container.innerHTML = '<p class="text-center text-sm text-gray-400 py-4">Adicione etapas √† sua campanha.</p>';
            updateHiddenTemplate();
            return;
        }

        container.innerHTML = '';
        
        window.campaignSteps.forEach((step, index) => {
            const el = document.createElement('div');
            el.className = 'relative group border border-slate-200 rounded bg-white p-3 flex gap-3 items-start';
            
            // √çcone do tipo
            let icon = '‚ùì';
            if (step.type === 'text') icon = 'üìù';
            if (step.type === 'media') icon = 'üñºÔ∏è';
            if (step.type === 'delay') icon = '‚è±Ô∏è';
            
            // Conte√∫do do Step
            let contentHtml = '';
            
            if (step.type === 'text') {
                contentHtml = `
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Mensagem de Texto</label>
                        <textarea 
                            id="step-text-${index}"
                            class="w-full text-sm border-slate-300 rounded-md focus:border-indigo-500 focus:ring-indigo-500" 
                            rows="3" 
                            placeholder="Ol√° {{nome}}..."
                            oninput="updateStep(${index}, 'content', this.value)"
                        >${step.content || ''}</textarea>
                        <div class="flex justify-between items-center mt-1">
                            <p class="text-[10px] text-gray-400">Vari√°veis: {{nome}}, {{empresa}}...</p>
                            <div class="flex gap-2">
                                <button type="button" onclick="generateSpintax(${index})" class="text-[10px] text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
                                    üîÑ Spintax (IA)
                                </button>
                                <button type="button" onclick="rewriteWithAI(${index})" class="text-[10px] text-green-600 hover:text-green-800 flex items-center gap-1">
                                    ‚ú® Melhorar (IA)
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (step.type === 'delay') {
                contentHtml = `
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Aguardar (segundos)</label>
                        <input 
                            type="number" 
                            class="w-24 text-sm border-slate-300 rounded-md focus:border-indigo-500 focus:ring-indigo-500" 
                            value="${step.time || 5}" 
                            min="1" 
                            max="120"
                            onchange="updateStep(${index}, 'time', parseInt(this.value))"
                        >
                    </div>
                `;
            } else if (step.type === 'media') {
                const isImage = step.content_type?.startsWith('image');
                const isVideo = step.content_type?.startsWith('video');
                const isAudio = step.content_type?.startsWith('audio');
                
                let preview = '';
                if (isImage) preview = `<img src="${step.media_url}" class="h-16 w-16 object-cover rounded border">`;
                else if (isVideo) preview = `<div class="h-16 w-16 bg-gray-100 flex items-center justify-center rounded border"><i class="fas fa-video text-gray-400"></i></div>`;
                else if (isAudio) preview = `<div class="h-16 w-16 bg-gray-100 flex items-center justify-center rounded border"><i class="fas fa-music text-gray-400"></i></div>`;
                else preview = `<div class="h-16 w-16 bg-gray-100 flex items-center justify-center rounded border"><i class="fas fa-file text-gray-400"></i></div>`;

                contentHtml = `
                    <div class="flex-1 flex gap-3">
                        ${preview}
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-gray-700 mb-1">M√≠dia: ${step.filename || 'Arquivo'}</label>
                            ${(isImage || isVideo) ? `
                                <input 
                                    type="text" 
                                    class="w-full text-sm border-slate-300 rounded-md mt-1 placeholder:text-gray-400" 
                                    placeholder="Legenda (opcional)"
                                    value="${step.caption || ''}"
                                    oninput="updateStep(${index}, 'caption', this.value)"
                                >
                            ` : ''}
                            ${isAudio ? `
                                <label class="inline-flex items-center gap-2 mt-1 text-xs text-slate-600">
                                    <input type="checkbox" class="rounded border-slate-300" 
                                        ${step.ppt !== false ? 'checked' : ''} 
                                        onchange="updateStep(${index}, 'ppt', this.checked)">
                                    Enviar como nota de voz (PTT)
                                </label>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Controles
            const controlsHtml = `
                <div class="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button type="button" onclick="moveStep(${index}, -1)" class="p-1 text-gray-400 hover:text-indigo-600" title="Mover para cima" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                    <button type="button" onclick="moveStep(${index}, 1)" class="p-1 text-gray-400 hover:text-indigo-600" title="Mover para baixo" ${index === window.campaignSteps.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button>
                    <button type="button" onclick="removeStep(${index})" class="p-1 text-gray-400 hover:text-red-600" title="Remover etapa">üóëÔ∏è</button>
                </div>
            `;

            el.innerHTML = `
                <div class="text-xl select-none cursor-move text-gray-300 pt-1">${icon}</div>
                ${contentHtml}
                ${controlsHtml}
            `;
            
            container.appendChild(el);
        });
        
        updateHiddenTemplate();
    };

    // --- Funcionalidades de IA ---

    async function rewriteWithAI(index) {
        const textarea = document.getElementById(`step-text-${index}`);
        const text = textarea.value;
        if (!text) return alert('Digite algo para a IA melhorar.');

        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚è≥ Gerando...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/v1/ai/rewrite', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ text: text, tone: 'persuasive' })
            });

            if (!response.ok) throw new Error('Falha na IA');
            
            const data = await response.json();
            textarea.value = data.rewritten;
            updateStep(index, 'content', data.rewritten);
            
        } catch (error) {
            alert('Erro ao conectar com a IA. Verifique sua chave de API.');
            console.error(error);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function generateSpintax(index) {
        const textarea = document.getElementById(`step-text-${index}`);
        const text = textarea.value;
        if (!text) return alert('Digite algo para gerar varia√ß√µes.');

        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚è≥ Gerando...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/v1/ai/spintax', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ text: text })
            });

            if (!response.ok) throw new Error('Falha na IA');
            
            const data = await response.json();
            textarea.value = data.spintax;
            updateStep(index, 'content', data.spintax);
            
        } catch (error) {
            alert('Erro ao conectar com a IA. Verifique sua chave de API.');
            console.error(error);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // --- L√≥gica de Sele√ß√£o de M√≠dia ---
    
    let isMediaLoading = false;

    async function openMediaSelector() {
        const modal = document.getElementById('media-selector-modal');
        modal.classList.remove('hidden');
        loadMediaGrid();
    }

    function closeMediaSelector() {
        document.getElementById('media-selector-modal').classList.add('hidden');
    }

    async function loadMediaGrid() {
        const grid = document.getElementById('media-selector-grid');
        if (isMediaLoading) return;
        isMediaLoading = true;
        
        try {
            const response = await fetch('/api/v1/media-gallery', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            
            if (!response.ok) throw new Error('Erro ao carregar m√≠dia');
            
            const items = await response.json();
            
                    if (items.length === 0) {
                        grid.innerHTML = `
                            <div class="col-span-3 text-center py-8 text-gray-500">
                                <p class="mb-4">Nenhuma m√≠dia encontrada.</p>
                                <a href="/media-gallery" class="inline-flex justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                                    Ir para Galeria e fazer Upload
                                </a>
                            </div>
                        `;
                        return;
                    }
            
            grid.innerHTML = items.map(item => `
                <div class="border rounded p-2 cursor-pointer hover:border-indigo-500 transition-colors" onclick="selectMedia('${item.id}', '${item.url}', '${item.filename}', '${item.content_type}')">
                    <div class="h-24 bg-gray-100 flex items-center justify-center overflow-hidden rounded mb-2">
                        ${item.content_type.startsWith('image') 
                            ? `<img src="${item.url}" class="h-full w-full object-cover">`
                            : `<i class="fas ${item.content_type.startsWith('video') ? 'fa-video' : 'fa-music'} text-2xl text-gray-400"></i>`
                        }
                    </div>
                    <p class="text-xs truncate text-center">${item.filename}</p>
                </div>
            `).join('');
            
        } catch (e) {
            grid.innerHTML = '<div class="col-span-3 text-center py-8 text-red-500">Erro ao carregar galeria.</div>';
        } finally {
            isMediaLoading = false;
        }
    }

    // Expor selectMedia globalmente
    window.selectMedia = function(id, url, filename, contentType) {
        addStep('media', {
            media_id: id,
            media_url: url,
            filename: filename,
            content_type: contentType,
            caption: '',
            ppt: true // default true for audio
        });
        closeMediaSelector();
    };

</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Chips | WHAGO{% endblock %}
{% block content %}
<section class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
  <div>
    <h2 class="page-title">Chips conectados</h2>
    <p class="page-subtitle">
      Gerencie sessÃµes WhatsApp, verifique status em tempo real e acompanhe eventos crÃ­ticos.
    </p>
  </div>
  <div class="flex items-center gap-3">
    <button data-test="add-chip" class="btn-primary">Adicionar chip</button>
    <button id="open-group-heatup" class="btn-secondary">ğŸ”¥ Aquecer em grupo</button>
    <button id="open-global-stats" class="btn-secondary text-blue-700 bg-blue-50 border-blue-200 hover:bg-blue-100">ğŸ“Š Monitoramento</button>
    <button id="refresh-chips" class="btn-secondary">Atualizar lista</button>
  </div>
</section>

<p id="chip-feedback" class="mt-4 text-sm text-slate-500"></p>

<section class="mt-4 card">
  <div class="overflow-x-auto">
    <table class="table-auto w-full text-sm" id="chip-table">
      <thead>
        <tr class="text-left text-slate-500">
          <th class="py-2">Alias</th>
          <th class="py-2">Status</th>
          <th class="py-2">PontuaÃ§Ã£o</th>
          <th class="py-2">Criado em</th>
          <th class="py-2">Ãšltima atividade</th>
          <th class="py-2 text-right">AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200"></tbody>
    </table>
  </div>
</section>

<section class="mt-8 grid gap-6 lg:grid-cols-2" id="chip-events"></section>

<div id="chip-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="chip-modal-title">
  <div class="modal__content">
    <div class="modal__header">
      <h3 id="chip-modal-title" class="modal__title">Adicionar novo chip</h3>
      <button type="button" id="chip-modal-close" class="modal__close" aria-label="Fechar">âœ•</button>
    </div>
    <form id="chip-form" class="modal__body space-y-4">
      <div class="space-y-2">
        <label for="chip-alias" class="card__label">Apelido do chip</label>
        <input id="chip-alias" name="alias" class="input" placeholder="Suporte WhatsApp 01" required minlength="3" />
        <p class="text-xs text-slate-500">Escolha um apelido Ãºnico para facilitar a identificaÃ§Ã£o nas campanhas.</p>
      </div>
      <div class="modal__actions">
        <button type="button" class="btn-secondary" id="chip-modal-cancel">Cancelar</button>
        <button type="submit" class="btn-primary" data-test="submit-chip">Criar chip</button>
      </div>
    </form>
    
    <!-- QR Code Section (shown after chip creation) -->
    <div id="chip-qr-section" class="modal__body space-y-4 hidden">
      <div class="text-center">
        <h4 class="text-lg font-semibold text-slate-700 mb-2">Escaneie o QR Code</h4>
        <p class="text-sm text-slate-600 mb-4">Abra o WhatsApp no seu celular e vÃ¡ em <strong>Aparelhos conectados</strong> â†’ <strong>Conectar um aparelho</strong></p>
      </div>
      
      <div class="flex justify-center">
        <div id="chip-qr-loading" class="text-center">
          <div class="inline-block h-12 w-12 animate-spin rounded-full border-4 border-solid border-primary border-r-transparent"></div>
          <p class="mt-2 text-sm text-slate-600">Gerando QR Code...</p>
        </div>
        <img id="chip-qr-image" src="" alt="QR Code" class="hidden w-64 h-64 border-2 border-slate-200 rounded-lg" />
      </div>
      
      <div id="chip-qr-status" class="text-center text-sm text-slate-600"></div>
      
      <div class="flex justify-center gap-3">
        <button type="button" id="chip-qr-close" class="btn-primary">Fechar</button>
      </div>
    </div>
  </div>
</div>
<div id="chip-modal-backdrop" class="modal__backdrop hidden" aria-hidden="true"></div>

<!-- Modal: Heat-up Individual com SeleÃ§Ã£o de Grupo -->
<div id="group-heatup-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="group-heatup-title">
  <div class="modal__content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
    <div class="modal__header">
      <h3 id="group-heatup-title" class="modal__title">ğŸ”¥ Configurar Aquecimento</h3>
      <button type="button" id="group-heatup-close" class="modal__close" aria-label="Fechar">âœ•</button>
    </div>
    <div class="modal__body space-y-6">
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
        <p class="text-sm text-blue-800">
          <strong>â„¹ï¸ Como funciona:</strong> Selecione pelo menos 2 chips conectados. Eles vÃ£o conversar entre si usando as mensagens que vocÃª configurar abaixo, seguindo um plano de aquecimento gradual.
        </p>
      </div>
      
      <!-- Chips disponÃ­veis -->
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <label class="card__label">1. Selecione os chips (mÃ­nimo 2)</label>
          <span id="selected-chips-count" class="text-xs text-slate-500">0 selecionados</span>
        </div>
        <div id="group-heatup-chips" class="space-y-2 max-h-48 overflow-y-auto border rounded-lg p-3 bg-slate-50"></div>
      </div>
      
      <!-- Mensagens -->
      <div class="space-y-3">
        <label class="card__label">2. Configure as mensagens</label>
        
        <!-- Upload de arquivo -->
        <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:border-slate-400 transition-colors">
          <input type="file" id="heatup-messages-file" accept=".txt,.csv" class="hidden" />
          <label for="heatup-messages-file" class="cursor-pointer">
            <p class="text-sm text-slate-600">
              ğŸ“ <span class="text-blue-600 hover:text-blue-700 font-medium">Clique para fazer upload</span> de arquivo .txt ou .csv
            </p>
            <p class="text-xs text-slate-400 mt-1">Uma mensagem por linha</p>
          </label>
        </div>
        
        <!-- Textarea manual -->
        <div class="space-y-2">
          <p class="text-xs text-slate-500">Mensagens padrÃ£o (edite ou substitua conforme necessÃ¡rio):</p>
          <textarea id="group-heatup-messages" rows="10" class="input font-mono text-xs" placeholder="As mensagens padrÃ£o serÃ£o carregadas automaticamente..."></textarea>
          <div class="flex items-center justify-between text-xs text-slate-500">
            <span id="messages-count">0 mensagens</span>
            <button type="button" id="clear-messages" class="text-red-600 hover:text-red-700">Limpar tudo</button>
          </div>
        </div>
        
        <!-- Preview das mensagens -->
        <div class="bg-slate-50 border rounded-lg p-3">
          <p class="text-xs font-medium text-slate-700 mb-2">ğŸ“ Preview das mensagens:</p>
          <div id="messages-preview" class="space-y-1 max-h-32 overflow-y-auto text-xs text-slate-600">
            <p class="text-slate-400 italic">Nenhuma mensagem ainda...</p>
          </div>
        </div>
      </div>
      
      <!-- Plano de aquecimento -->
      <div class="bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-lg p-4">
        <p class="text-sm font-medium text-slate-800 mb-3">ğŸ“‹ Plano de Aquecimento (5 fases - 72h totais)</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
          <div class="flex items-center gap-2">
            <span class="text-orange-600">â—</span>
            <span class="text-slate-700"><strong>Fase 1:</strong> 20 msg/h por 4h</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-orange-600">â—</span>
            <span class="text-slate-700"><strong>Fase 2:</strong> 40 msg/h por 8h</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-amber-600">â—</span>
            <span class="text-slate-700"><strong>Fase 3:</strong> 60 msg/h por 12h</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-amber-600">â—</span>
            <span class="text-slate-700"><strong>Fase 4:</strong> 80 msg/h por 24h</span>
          </div>
          <div class="flex items-center gap-2 md:col-span-2">
            <span class="text-green-600">â—</span>
            <span class="text-slate-700"><strong>Fase 5:</strong> 120 msg/h por 24h</span>
          </div>
        </div>
        <p class="text-xs text-slate-600 mt-3 pt-3 border-t border-orange-200">
          <strong>âš ï¸ Importante:</strong> Os chips vÃ£o conversar entre si de forma natural, respeitando intervalos aleatÃ³rios e usando proxies para evitar detecÃ§Ã£o.
        </p>
      </div>
    </div>
    <div class="modal__footer">
      <button type="button" class="btn-secondary" id="group-heatup-cancel">Cancelar</button>
      <button type="button" class="btn-primary" id="group-heatup-start">ğŸ”¥ Iniciar Aquecimento</button>
    </div>
  </div>
</div>
<div id="group-heatup-backdrop" class="modal__backdrop hidden" aria-hidden="true"></div>

<!-- Modal: EstatÃ­sticas de MaturaÃ§Ã£o -->
<div id="maturation-stats-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="maturation-stats-title">
  <div class="modal__content" style="max-width: 800px;">
    <div class="modal__header">
      <h3 id="maturation-stats-title" class="modal__title">ğŸ“Š EstatÃ­sticas de MaturaÃ§Ã£o</h3>
      <button type="button" id="maturation-stats-close" class="modal__close" aria-label="Fechar">âœ•</button>
    </div>
    <div class="modal__body" id="maturation-stats-content">
      <p class="text-center text-slate-500">Carregando...</p>
    </div>
    <div class="modal__footer">
      <button type="button" class="btn-secondary" id="maturation-stats-cancel">Fechar</button>
      <button type="button" class="btn-primary" id="maturation-stats-refresh">ğŸ”„ Atualizar</button>
    </div>
  </div>
</div>
<div id="maturation-stats-backdrop" class="modal__backdrop hidden" aria-hidden="true"></div>

<!-- Modal: Monitoramento Global de Aquecimento -->
<div id="global-stats-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="global-stats-title">
  <div class="modal__content" style="max-width: 900px;">
    <div class="modal__header">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ğŸ”¥</span>
        <div>
          <h3 id="global-stats-title" class="modal__title">Monitoramento de Aquecimento Global</h3>
          <p class="text-xs text-slate-500">VisÃ£o geral de todos os chips em processo de maturaÃ§Ã£o</p>
        </div>
      </div>
      <button type="button" id="global-stats-close" class="modal__close" aria-label="Fechar">âœ•</button>
    </div>
    
    <div class="modal__body space-y-6" id="global-stats-content">
      <p class="text-center text-slate-500 py-8">Carregando dados...</p>
    </div>
    
    <div class="modal__footer">
      <button type="button" class="btn-secondary" id="global-stats-refresh">ğŸ”„ Atualizar Dados</button>
      <button type="button" class="btn-primary" id="global-stats-ok">Fechar</button>
    </div>
  </div>
</div>
<div id="global-stats-backdrop" class="modal__backdrop hidden" aria-hidden="true"></div>
{% endblock %}
